language: node_js
node_js: 16

branches:
  only:
    - main
    - /^v\d+\.\d+\.\d+$/

stages:
  - name: test
    if: tag IS blank
  - name: deploy

jobs:
  fast_finish: true
  include:
    - name: "Test"
      stage: test
      before_install:
        - git config --local user.name "LTO Network"
        - git config --local user.email "info@ltonetwork.com"
      install:
        - npm install
      script:
        - npm test
    - name: "Publish GitHub release"
      stage: deploy
      if: branch = main AND type = push
      before_script:
        - CURRENT_VERSION=$(git describe --tags --abbrev=0)
        - |
          if (git log $CURRENT_VERSION..HEAD | grep -q -i "\[bump:major\]"); then
            NEXT_VERSION=$(awk -F. -v OFS=. '{$1++;$2=0;$3=0;print}' <<< "$CURRENT_VERSION")
          elif (git log $CURRENT_VERSION..HEAD | grep -q -i "\[bump:minor\]"); then
            NEXT_VERSION=$(awk -F. -v OFS=. '{$2++;$3=0;print}' <<< "$CURRENT_VERSION")
          else
            NEXT_VERSION=$(awk -F. -v OFS=. '{$3++;print}' <<< "$CURRENT_VERSION")
          fi
      script:
        - git tag "$NEXT_VERSION"
      before_deploy:
        - npm run build
      deploy:
        provider: releases
        api_key:
          secure: "ZjyDb8AyEU53KXXRJjdFi2agZpIiwclDm0gSbJasMKRiMN+SLE4gykWtf6Ivzk1qCa+E090qDhdMHoo4M+NY97qS5TeuOF7Hv9YOMBgiNtvEKpYAZPwUoZqKWSz1sMm6j2n+jWWqWiOjPJDwONwn9BfayHiLSuJ/yiqsNuzy1HzDY7cOAU5XY+cclY6ZCEsu0b0l9apxxVgbMJxLpxlxFc5abo8KuClSDJGtHcYK8SqA8hXHf0pb33LoXL9nnVnzAngcAD6GKb6V803AaTSc8VWSmDERYunwQBPbeL+zXv61J/zMR6RYfkywI15+2RjEcF0mW/bOQwtqo0b7PdK34ZCLxhJwZXf5DPzbDIVZZpVlIuVOdND7clcnNvAsXvqNlTPxExDRwH7ddfnSlWclZKc2x1Q5hhDb7jP7IZrSFBQnYbErGl/PuqgsvYF5cFVyqrMobiUuN2NaqsqHqCvbUIPRGRKoXUDs93MrDQ6Gn/tvfuWoU2PFsWCjHj6Lrp+EhJA9oH474r6//T5nqqtMVbmzKdKVfLPcsGf6yIkHXFo1IJspcPU+GJi6m9eODWFHhLISbjBqDOOWl29nU1848NUXoUjYHLzWGGEr6L1wToJAD/b8weOOM5Vte7Iu9h63lBc0zjWo8Uum0mX5F2c7vGKAodPFIt045E4zB7pKaUo="
        cleanup: false
        on:
          all_branches: true
        file_glob: true
        file: dist/*
    - name: "Publish to NPM"
      stage: deploy
      if: tag IS present
      before_install:
        - npm version $TRAVIS_TAG --no-git-tag-version
      script:
        - npx tsc
      deploy:
        provider: npm
        email: arnold@jasny.net
        api_key:
          secure: "PuVV8v+me7JcwW3e96Q8ddqxFAyingmdTn5iNsc9tkZrckLHGKo33zCPXQ7zRIiYqhAZgKo2Pdn8rfBDmxpjX99YhBIxVGSLOVSovibIq1Pu61hWdiFeqWDI1UcGqiSK9bPEZOkPQ3CfCjO1rUGvvaeJ+It492z3zzE/4T8K5Yzwpxyd1sqHnO+3X5OV873k/x/IAYTbQ/uVRO9sWs2x2IWi9LLR5no9KLkz6Y387fSetFDLsc35V7/Qdzo+1k6ysHErQFZm3lxSey8vNEqhlDzsKlWCXJpFbHUQy6Ji3KiNrmJOBNvZ7I1GeiQT8qBQpEcnPPkWnEg6pA5gptkhjLopyW3GqYKmUvXFuErorf4xeAFkoj1gE5BnnLS5PnzCPLjs2fxgZeiGf3KjHmInX6iRau0h3NnWQYe/n+K+b5PdVZqEWg2t55Wktin3HfPx39XR6Gb4AWak9zJlO7y6cpJZL49k6xSzuZ2mA5p3xrKqMnA3tmsqayJpOAP7Atj2tRUsacK/P+umuE6PO91TtR4VOR9kNfplGJXWpM37HajzDi5X8yjiTfTLlf+rAoOggTXdcryfDO9wuORCCLyxeW1qC8X3rB0St9xsshQ7xl5UKE8ikzA5yxwN5CPJy0YXrrnNj1+HOX0MWFxIgt+OFcxCV6YjT8C2VRkFSF3+bXs="
        on:
          tags: true
        cleanup: false
